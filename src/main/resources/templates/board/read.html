<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<th:block th:replace="~{/layout/index :: setContent(~{this::content})}">
  <th:block th:fragment="content">
    <h1>Guestbook Read Page</h1>

    <div class="form-group">
      <label for="bno">bno</label>
      <input type="text" class="form-control" name="bno" placeholder="bno" id="bno" th:value="${dto.bno}" readonly="readonly">
    </div>
    <div class="form-group">
      <label for="title">Title</label>
      <input type="text" class="form-control" name="title" placeholder="title" id="title" th:value="${dto.title}" readonly="readonly">
    </div>
    <div class="form-group">
      <label>Content</label>
      <textarea class="form-control" name="content" placeholder="Content"  readonly="readonly">[[${dto.content}]]</textarea>
    </div>
    <div class="form-group">
      <label>Writer</label>
      <input type="text" class="form-control" name="writerName" placeholder="Writer" th:value="${dto.writerName}" readonly="readonly">
    </div>
    <div class="form-group my-4">
      <label>regDate</label>
      <input type="text" class="form-control" name="regDate" placeholder="regDate" th:value="${#temporals.format(dto.regDate, 'yyyy-MM-dd')}" readonly="readonly">
<!--      th:value="${#temporals.format(dto.regDate,'yyyy/MM/dd')-->
    </div>
    <a class="btn btn-primary mt-3"
       th:href="@{/board/modify(page = ${requestDto.page}, size = ${requestDto.size}, bno = ${dto.bno}, type=${requestDto.type}, keyword=${requestDto.keyword})}">modify</a>
    <a th:href="@{/board/list(page = ${requestDto.page}, size = ${requestDto.size}, type=${requestDto.type}, keyword=${requestDto.keyword})}" class="btn btn-primary mt-3">List</a>

    <div class="mt-4">
      <h5><button class="badge bg-info addReply p-2 text-decoration-none text-white border-0"> Add Reply</button></h5>
      <h5><button class="badge bg-secondary replyCount p-2 text-decoration-none text-white board-0"> Reply Count [[${dto.replyCount}]]</button></h5>
      <ul class="list-group replyList">

      </ul>
    </div>
  </th:block>
</th:block>

<!-- The Modal -->
<div class="modal">
  <div class="modal-dialog">
    <div class="modal-content">

      <!-- Modal Header -->
      <div class="modal-header">
        <h4 class="modal-title">Modal Heading</h4>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <!-- Modal body -->
      <div class="modal-body">
        <div class="form-group">
          <input class="form-control" type="text" name="text" placeholder="ReplyText...">
        </div>
        <div class="form-group">
          <input class="form-control" type="text" name="replyer" placeholder="Replyer">
        </div>
        <input type="hidden" name="rno">
      </div>

      <!-- Modal footer -->
      <div class="modal-footer">
        <button type="button" class="btn btn-primary replyRemove">Remove</button>
        <button type="button" class="btn btn-primary replyModify">Modify</button>
        <button type="button" class="btn btn-primary replySave">Save</button>
        <button type="button" class="btn btn-outline-secondary replyClose" data-bs-dismiss="modal">Close</button>

      </div>

    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.13/dayjs.min.js" integrity="sha512-FwNWaxyfy2XlEINoSnZh1JQ5TRRtGow0D6XcmAWmYCRgvqOUTnzCxPc9uF35u5ZEpirk1uhlPVA19tflhvnW1g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.13/plugin/relativeTime.min.js" integrity="sha512-MVzDPmm7QZ8PhEiqJXKz/zw2HJuv61waxb8XXuZMMs9b+an3LoqOqhOEt5Nq3LY1e4Ipbbd/e+AWgERdHlVgaA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.13/locale/ko.min.js" integrity="sha512-ycjm4Ytoo3TvmzHEuGNgNJYSFHgsw/TkiPrGvXXkR6KARyzuEpwDbIfrvdf6DwXm+b1Y+fx6mo25tBr1Icg7Fw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script th:inline="javascript">
  window.addEventListener("load", e => {
    dayjs.extend(window.dayjs_plugin_relativeTime)
    dayjs.locale('ko')

    const bno = [[${dto.bno}]];  //ë³€ìˆ˜í˜¸ì¶œ ë°©ì‹ì˜ ì•ˆì •ì ì¸ ë³´ì¥ì„ ìœ„í•´ì„œ
    const listGroup = document.querySelector(".replyList");
    const myModal = new bootstrap.Modal(document.querySelector('.modal'));
    const loadJSONData = () => {
      //e.type -> click ì´ë ‡ê²Œ ë‚˜ì˜¨ë‹¤.
      //dayjs ì „ì—­ ì„¤ì •
      fetch(`/replies/board/${bno}`)
              .then(resp => resp.json())
              .then(arr => {   //ì—¬ê¸°ì„œ thisëŠ” windowsê°ì²´ ì´ë‹¤.
                console.log(arr);
                //success function;  //ì´ë²¤íŠ¸ ìœ„ì„ query selecter, í…œí”Œë¦¿ ë¦¬í„°ëŸ´ì„ ì‚¬ìš©í•˜ì—¬ ì‘ì„±
                document.querySelector(".replyCount").innerHTML = "Reply Count" + arr.length; // ê¸°ì¡´ ë¦¬ìŠ¤íŠ¸ ì´ˆê¸°í™”
                listGroup.innerHTML = arr.map(r => {  //,  listGroupì˜ ë‚´ë¶€ì— htmlì„ ë§Œë“¬
                  console.log(r)  //ë¬¸ìì—´ ë°°ì—´ë“¤,
                  return `
                <li class="card list-group-item" data-rno="${r.rno}"><b>${r.rno}</b>
                <div class="card-body">
                   <h5 class="card-title">${r.text}</h5>
                     <h5 class="card-subtitle mb-2 text-muted">${r.replyer}</h5>
                   <p class="card-text">${dayjs(r.regDate).fromNow()}</p>
                 </div>
                </li>
              `;
                }).join("")
              })
    };


    document.querySelector('.replyCount').addEventListener("click", () => loadJSONData()); //ë°°ì—´ì„ ë¬¸ìë¡œ í•©ì¹¨. ë¬¸ìì—´ ë°°ì—´ì„ í†µí•©ëœ ë¬¸ìì—´ë¡œ ì¶œë ¥í•˜ëŠ” ê³¼ì •ì´ ìˆì–´ì•¼í•¨

    document.querySelector('.addReply').addEventListener("click", () => {


      document.querySelectorAll('.modal input[type=text]').forEach(i => i.value = '');
      [...document.querySelectorAll(".modal-footer button")].filter(b => {
        b.classList.add('d-none');
        return b.matches('.replyClose, .replySave');
      }).forEach(b => b.classList.remove('d-none'));
      //console.log(b.matches('.replyClose, .replySave'));
      myModal.show();
      //click ev ë¶€ì—¬
      //reph obj ì •ë¦½
      //controller ì œì‘
      //fetch call
      //then ì´í•˜ ì²˜ë¦¬ //ì „ë¶€ í…ŒìŠ¤íŠ¸
    });

    document.querySelector('.replySave').addEventListener('click', e => {
      //1
      console.log("save ì„ íƒ");
      //2
      const reply = {bno}
      console.log(reply);
      e.target.closest(".modal").querySelectorAll("input[type=text]").forEach(i => reply[i.name] = i.value);
      console.log(reply);

      fetch("/replies", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(reply)
      })
              .then(resp => resp.json())
              .then(data => {
                console.log(data);
                alert(data + "ë²ˆ ëŒ“ê¸€ ë“±ë¡ë¨")
                myModal.hide();
                loadJSONData(e);
              });
    })

    document.querySelector('.replyList').addEventListener('click', function (e) {
      const target = e.target;

      // í´ë¦­ëœ ìš”ì†Œ ë˜ëŠ” ê·¸ ë¶€ëª¨ê°€ .card-body ì¸ì§€ í™•ì¸
      const cardBody = target.closest('.card-body');
      if (cardBody && this.contains(cardBody)) {

        // ê°€ì¥ ê°€ê¹Œìš´ .card ìš”ì†Œë¥¼ ì°¾ê³  data-rno ê°’ì„ ê°€ì ¸ì˜¤ê¸°
        const card = cardBody.closest('.card');
        if (card) {
          const rno = card.getAttribute('data-rno');

          [...document.querySelectorAll(".modal-footer button")].filter(b => {
            b.classList.add('d-none');
            return b.matches('.replyModify, .replyRemove, .replyClose');
          }).forEach(b => b.classList.remove('d-none'));

          // ì¹´ë“œ ë‚´ë¶€ì—ì„œ í…ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
          const text = card.querySelector('.card-title')?.textContent.trim();
          const replyer = card.querySelector('.card-subtitle')?.textContent.trim();


          document.querySelector("input[name='rno']").value = rno;
          document.querySelector("input[name='text']").value = text || '';
          document.querySelector("input[name='replyer']").value = replyer || '';

          myModal.show();
        }
      }
    });

    document.querySelector('.replyRemove').addEventListener('click', e => {
      const rno = document.querySelector("input[name='rno']").value;

      if (!rno) {
        alert("ëŒ“ê¸€ ë²ˆí˜¸ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        return;
      }

      if (!confirm(`${rno}ë²ˆ ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

      fetch(`/replies/${rno}`, {
        method: "DELETE"
      })
              .then(resp => {
                if (!resp.ok) throw new Error("ì‚­ì œ ì‹¤íŒ¨");
                return resp.text(); // í˜¹ì€ .json() ì„œë²„ ë°˜í™˜ì— ë”°ë¼
              })
              .then(data => {
                alert(`${rno}ë²ˆ ëŒ“ê¸€ ì‚­ì œë¨`);
                myModal.hide();
                loadJSONData(e);  // ëŒ“ê¸€ ëª©ë¡ ì¬ë¡œë“œ
              })
              .catch(err => {
                console.error(err);
                alert("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
              });
    });

    document.querySelector('.replyModify').addEventListener('click', e => {
      const rno = document.querySelector("input[name='rno']").value;

      if (!rno) {
        alert("ëŒ“ê¸€ ë²ˆí˜¸ê°€ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      const modalElement = document.querySelector('.modal');

      const reply = { rno };

      // ëŒ“ê¸€ ì‘ì„±ìì™€ ë‚´ìš© ìˆ˜ì§‘
      modalElement.querySelectorAll("input[type=text]").forEach(i => {
        reply[i.name] = i.value;
      });

      // ğŸ“Œ bno ì „ì—­ ë³€ìˆ˜ë„ reply ê°ì²´ì— í¬í•¨ì‹œí‚´
      reply.bno = bno;

      console.log("ìˆ˜ì •í•  ë‚´ìš©:", reply);

      fetch(`/replies/${rno}`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(reply)
      })
              .then(resp => {
                if (!resp.ok) throw new Error("ìˆ˜ì • ì‹¤íŒ¨");
                return resp.text();
              })
              .then(data => {
                alert(`${rno}ë²ˆ ëŒ“ê¸€ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                myModal.hide();
                loadJSONData(e);
              })
              .catch(err => {
                console.error(err);
                alert("ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
              });
    });
  })

</script>
</html>